<project name="Compiler" default="all" basedir="../">

    <description>
		ant file for project
	</description>

    <!-- default target -->
    <target name="all" description="compile sources and create jar file" depends="build,buildJar" />

    <!-- set global properties for this build -->
	<property name="src" location="src" />
	<property name="tests" location="tests" />
	<property name="bin" location="bin" />
	<property name="target" location="target" />

	<property name="jarLocation" location="${target}/${ant.project.name}.jar" />

	<property name="commons-cli" location="lib/commons-cli-1.2.jar" />

	<path id="classpath.base">
		<pathelement location="${commons-cli}" />
	</path>


	<path id="classpath.test">
		<pathelement location="lib/junit-4.11.jar" />
		<pathelement location="lib/hamcrest-core-1.3.jar" />
		<pathelement location="${bin}" />
		<path refid="classpath.base" />
	</path>


	<target name="clean-build" depends="clean" description="compile the source">
		<!-- Compile the java code from ${src} into ${bin} -->
		<mkdir dir="${bin}" />
		<javac srcdir="${src}" destdir="${bin}" includeantruntime="false">
			<classpath refid="classpath.base" />
		</javac>
		<echo message="Build done" />
	</target>

    <target name="clean" description="clean up">
        <delete dir="${bin}" />
        <delete dir="${target}" />
    </target>

	<target name="buildJar" depends="build">
		<mkdir dir="${target}" />
		<jar destfile="${jarLocation}" filesetmanifest="mergewithoutmain">
			<manifest>
				<attribute name="Main-Class" value="compiler.main.CompilerApp" />
				<attribute name="Class-Path" value="./lib/commons-cli-1.2.jar" />
			</manifest>
			<fileset dir="${bin}" />
			<zipfileset excludes="META-INF/*.SF" src="${commons-cli}" />
		</jar>
	</target>


	<!-- Builds the jar file and tries to execute it as a simple test -->
	<target name="testJar" depends="buildJar">
		<exec executable="java">
			<arg value="-jar" />
			<arg value="${jarLocation}" />
			<arg value="--help" />
		</exec>
	</target>


	<target name="all" description="clean and build everything, run tests and build jar file">
		<antcall target="test" />
		<antcall target="testJar" />
	</target>



	<target name="buildTests" description="compile test sources"
		depends="clean-build">
		<javac srcdir="${tests}" destdir="${bin}" includeantruntime="false">
			<classpath refid="classpath.test" />
		</javac>
		<echo message="Build of tests done" />
	</target>

	<target name="test" depends="buildTests">
		<junit printsummary="on" fork="true" dir="${basedir}"
			haltonfailure="yes">
			<classpath>
				<path refid="classpath.test" />
			</classpath>

			<formatter type="brief" usefile="false" />

			<batchtest>
				<fileset dir="${tests}" includes="**/*Test*.java" />
			</batchtest>
		</junit>
	</target>
</project>
